#!/bin/bash
# 🚀 multi-agent-bridge 出撃スクリプト（毎日の起動用）
# Daily Launch Script for Multi-Agent Orchestration System
#
# 使用方法:
#   ./launch.sh           # 全エージェント起動（通常）
#   ./launch.sh -s        # セットアップのみ（Claude起動なし）
#   ./launch.sh -h        # ヘルプ表示

set -e

# スクリプトのディレクトリを取得（ブリッジシステム基準点）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# 言語設定を読み取り（デフォルト: ja）
LANG_SETTING="ja"
if [ -f "./config/settings.yaml" ]; then
    LANG_SETTING=$(grep "^language:" ./config/settings.yaml 2>/dev/null | awk '{print $2}' || echo "ja")
fi

# シェル設定を読み取り（デフォルト: bash）
SHELL_SETTING="bash"
if [ -f "./config/settings.yaml" ]; then
    SHELL_SETTING=$(grep "^shell:" ./config/settings.yaml 2>/dev/null | awk '{print $2}' || echo "bash")
fi

# 色付きログ関数（UC風）
log_info() {
    echo -e "\033[1;33m【報】\033[0m $1"
}

log_success() {
    echo -e "\033[1;32m【成】\033[0m $1"
}

log_war() {
    echo -e "\033[1;31m【戦闘】\033[0m $1"
}

# ═══════════════════════════════════════════════════════════════════════════════
# プロンプト生成関数（bash/zsh対応）
# ───────────────────────────────────────────────────────────────────────────────
# 使用法: generate_prompt "ラベル" "色" "シェル"
# 色: red, green, blue, magenta, cyan, yellow
# ═══════════════════════════════════════════════════════════════════════════════
generate_prompt() {
    local label="$1"
    local color="$2"
    local shell_type="$3"

    if [ "$shell_type" == "zsh" ]; then
        # zsh用: %F{color}%B...%b%f 形式
        echo "(%F{${color}}%B${label}%b%f) %F{green}%B%~%b%f%# "
    else
        # bash用: \[\033[...m\] 形式
        local color_code
        case "$color" in
            red)     color_code="1;31" ;;
            green)   color_code="1;32" ;;
            yellow)  color_code="1;33" ;;
            blue)    color_code="1;34" ;;
            magenta) color_code="1;35" ;;
            cyan)    color_code="1;36" ;;
            *)       color_code="1;37" ;;  # white (default)
        esac
        echo "(\[\033[${color_code}m\]${label}\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ "
    fi
}

# ═══════════════════════════════════════════════════════════════════════════════
# オプション解析
# ═══════════════════════════════════════════════════════════════════════════════
SETUP_ONLY=false
OPEN_TERMINAL=false
SHELL_OVERRIDE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--setup-only)
            SETUP_ONLY=true
            shift
            ;;
        -t|--terminal)
            OPEN_TERMINAL=true
            shift
            ;;
        -shell|--shell)
            if [[ -n "$2" && "$2" != -* ]]; then
                SHELL_OVERRIDE="$2"
                shift 2
            else
                echo "エラー: -shell オプションには bash または zsh を指定してください"
                exit 1
            fi
            ;;
        -h|--help)
            echo ""
            echo "🚀 multi-agent-bridge 出撃スクリプト"
            echo ""
            echo "使用方法: ./launch.sh [オプション]"
            echo ""
            echo "オプション:"
            echo "  -s, --setup-only    tmuxセッションのセットアップのみ（Claude起動なし）"
            echo "  -t, --terminal      Windows Terminal で新しいタブを開く"
            echo "  -shell, --shell SH  シェルを指定（bash または zsh）"
            echo "                      未指定時は config/settings.yaml の設定を使用"
            echo "  -h, --help          このヘルプを表示"
            echo ""
            echo "例:"
            echo "  ./launch.sh              # 全エージェント起動（通常の出撃）"
            echo "  ./launch.sh -s           # セットアップのみ（手動でClaude起動）"
            echo "  ./launch.sh -t           # 全エージェント起動 + ターミナルタブ展開"
            echo "  ./launch.sh -shell bash  # bash用プロンプトで起動"
            echo "  ./launch.sh -shell zsh   # zsh用プロンプトで起動"
            echo ""
            echo "エイリアス:"
            echo "  csst  → cd /mnt/c/tools/multi-agent-bridge && ./launch.sh"
            echo "  css   → tmux attach-session -t bridge"
            echo "  csm   → tmux attach-session -t hangar"
            echo ""
            exit 0
            ;;
        *)
            echo "不明なオプション: $1"
            echo "./launch.sh -h でヘルプを表示"
            exit 1
            ;;
    esac
done

# シェル設定のオーバーライド（コマンドラインオプション優先）
if [ -n "$SHELL_OVERRIDE" ]; then
    if [[ "$SHELL_OVERRIDE" == "bash" || "$SHELL_OVERRIDE" == "zsh" ]]; then
        SHELL_SETTING="$SHELL_OVERRIDE"
    else
        echo "エラー: -shell オプションには bash または zsh を指定してください（指定値: $SHELL_OVERRIDE）"
        exit 1
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 出撃バナー表示（CC0ライセンスASCIIアート使用）
# ───────────────────────────────────────────────────────────────────────────────
# 【著作権・ライセンス表示】
# 忍者ASCIIアート: syntax-samurai/ryu - CC0 1.0 Universal (Public Domain)
# 出典: https://github.com/syntax-samurai/ryu
# "all files and scripts in this repo are released CC0 / kopimi!"
# ═══════════════════════════════════════════════════════════════════════════════
show_battle_cry() {
    clear

    # タイトルバナー（色付き）
    echo ""
    echo -e "\033[1;36m╔══════════════════════════════════════════════════════════════════════════════════╗\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m██╗      █████╗ ██╗   ██╗███╗   ██╗ ██████╗██╗  ██╗██╗██╗██╗\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m██║     ██╔══██╗██║   ██║████╗  ██║██╔════╝██║  ██║██║██║██║\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m██║     ███████║██║   ██║██╔██╗ ██║██║     ███████║██║██║██║\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m██║     ██╔══██║██║   ██║██║╚██╗██║██║     ██╔══██║╚═╝╚═╝╚═╝\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m███████╗██║  ██║╚██████╔╝██║ ╚████║╚██████╗██║  ██║██╗██╗██╗\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m║\033[0m \033[1;32m╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝ ╚═════╝╚═╝  ╚═╝╚═╝╚═╝╚═╝\033[0m            \033[1;36m║\033[0m"
    echo -e "\033[1;36m╠══════════════════════════════════════════════════════════════════════════════════╣\033[0m"
    echo -e "\033[1;36m║\033[0m       \033[1;37m出撃開始!!!\033[0m    \033[1;31m🚀\033[0m    \033[1;32mローンチシークエンス開始！\033[0m                  \033[1;36m║\033[0m"
    echo -e "\033[1;36m╚══════════════════════════════════════════════════════════════════════════════════╝\033[0m"
    echo ""

    # ═══════════════════════════════════════════════════════════════════════════
    # パイロット配備（オリジナル）
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "\033[1;34m  ╔═════════════════════════════════════════════════════════════════════════════╗\033[0m"
    echo -e "\033[1;34m  ║\033[0m                    \033[1;37m【 パイロット配備 ・ 八 機 展 開 】\033[0m                    \033[1;34m║\033[0m"
    echo -e "\033[1;34m  ╚═════════════════════════════════════════════════════════════════════════════╝\033[0m"

    cat << 'PILOT_EOF'

       /\      /\      /\      /\      /\      /\      /\      /\
      /MS\    /MS\    /MS\    /MS\    /MS\    /MS\    /MS\    /MS\
     /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\
      |  |    |  |    |  |    |  |    |  |    |  |    |  |    |  |
     /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\  /|  |\
     /    \  /    \  /    \  /    \  /    \  /    \  /    \  /    \
     [P-1]   [P-2]   [P-3]   [P-4]   [P-5]   [P-6]   [P-7]   [P-8]

PILOT_EOF

    echo -e "                    \033[1;36m「「「 了解！！ 全機発進する！！ 」」」\033[0m"
    echo ""

    # ═══════════════════════════════════════════════════════════════════════════
    # システム情報
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "\033[1;33m  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓\033[0m"
    echo -e "\033[1;33m  ┃\033[0m  \033[1;37m🚀 multi-agent-bridge\033[0m  〜 \033[1;36mUCマルチエージェント艦隊管制システム\033[0m 〜         \033[1;33m┃\033[0m"
    echo -e "\033[1;33m  ┃\033[0m                                                                           \033[1;33m┃\033[0m"
    echo -e "\033[1;33m  ┃\033[0m    \033[1;35m艦長\033[0m: プロジェクト統括    \033[1;31m戦術長\033[0m: タスク管理  \033[1;34mパイロット\033[0m: 実働部隊×8  \033[1;33m┃\033[0m"
    echo -e "\033[1;33m  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛\033[0m"
    echo ""
}

# バナー表示実行
show_battle_cry

echo -e "  \033[1;33mローンチシークエンス開始！戦闘配備に移行する\033[0m (Initiating launch sequence)"
echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1: 既存セッションクリーンアップ
# ═══════════════════════════════════════════════════════════════════════════════
log_info "🧹 既存のセッションを切断中..."
tmux kill-session -t hangar 2>/dev/null && log_info "  └─ hangarセッション、切断完了" || log_info "  └─ hangarセッションは存在せず"
tmux kill-session -t bridge 2>/dev/null && log_info "  └─ bridgeセッション、切断完了" || log_info "  └─ bridgeセッションは存在せず"

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 1.5: 前回ミッションログのバックアップ（内容がある場合のみ）
# ═══════════════════════════════════════════════════════════════════════════════
BACKUP_DIR="./logs/backup_$(date '+%Y%m%d_%H%M%S')"
NEED_BACKUP=false

if [ -f "./dashboard.md" ]; then
    if grep -q "cmd_" "./dashboard.md" 2>/dev/null; then
        NEED_BACKUP=true
    fi
fi

if [ "$NEED_BACKUP" = true ]; then
    mkdir -p "$BACKUP_DIR" || true
    cp "./dashboard.md" "$BACKUP_DIR/" 2>/dev/null || true
    cp -r "./queue/reports" "$BACKUP_DIR/" 2>/dev/null || true
    cp -r "./queue/tasks" "$BACKUP_DIR/" 2>/dev/null || true
    cp "./queue/captain_to_tactical.yaml" "$BACKUP_DIR/" 2>/dev/null || true
    log_info "📦 前回のミッションログをバックアップ: $BACKUP_DIR"
fi

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 2: 報告ファイルリセット
# ═══════════════════════════════════════════════════════════════════════════════
log_info "📜 前回のブリーフィング記録を破棄中..."

# queue ディレクトリが存在しない場合は作成
[ -d ./queue/reports ] || mkdir -p ./queue/reports
[ -d ./queue/tasks ] || mkdir -p ./queue/tasks

# パイロットタスクファイルリセット
for i in {1..8}; do
    cat > ./queue/tasks/pilot${i}.yaml << EOF
# パイロット${i}専用タスクファイル
task:
  task_id: null
  parent_cmd: null
  description: null
  target_path: null
  status: idle
  timestamp: ""
EOF
done

# パイロットレポートファイルリセット
for i in {1..8}; do
    cat > ./queue/reports/pilot${i}_report.yaml << EOF
worker_id: pilot${i}
task_id: null
timestamp: ""
status: idle
result: null
EOF
done

# コマンドキューリセット
cat > ./queue/captain_to_tactical.yaml << 'EOF'
queue: []
EOF

cat > ./queue/tactical_to_pilot.yaml << 'EOF'
assignments:
  pilot1:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot2:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot3:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot4:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot5:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot6:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot7:
    task_id: null
    description: null
    target_path: null
    status: idle
  pilot8:
    task_id: null
    description: null
    target_path: null
    status: idle
EOF

log_success "✅ デッキクリア完了"

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 3: ダッシュボード初期化
# ═══════════════════════════════════════════════════════════════════════════════
log_info "📊 オペレーションボードを初期化中..."
TIMESTAMP=$(date "+%Y-%m-%d %H:%M")

if [ "$LANG_SETTING" = "ja" ]; then
    # 日本語のみ
    cat > ./dashboard.md << EOF
# 📊 作戦状況報告
最終更新: ${TIMESTAMP}

## 🚨 要対応 - 提督の判断を待つ
なし

## 🔄 進行中 - 現在オペレーション遂行中である
なし

## ✅ 本日の戦果
| 時刻 | 作戦区域 | 任務 | 結果 |
|------|----------|------|------|

## 🎯 スキル化候補 - 承認待ち
なし

## 🛠️ 生成されたスキル
なし

## ⏸️ 待機中
なし

## ❓ 確認事項
なし
EOF
else
    # 日本語 + 翻訳併記
    cat > ./dashboard.md << EOF
# 📊 作戦状況報告 (Operation Status Report)
最終更新 (Last Updated): ${TIMESTAMP}

## 🚨 要対応 - 提督の判断を待つ (Action Required - Awaiting Admiral's Decision)
なし (None)

## 🔄 進行中 - 現在オペレーション遂行中である (In Progress - Operation Underway)
なし (None)

## ✅ 本日の戦果 (Today's Achievements)
| 時刻 (Time) | 作戦区域 (Operation Zone) | 任務 (Mission) | 結果 (Result) |
|------|------|------|------|

## 🎯 スキル化候補 - 承認待ち (Skill Candidates - Pending Approval)
なし (None)

## 🛠️ 生成されたスキル (Generated Skills)
なし (None)

## ⏸️ 待機中 (On Standby)
なし (None)

## ❓ 確認事項 (Questions for Admiral)
なし (None)
EOF
fi

log_success "  └─ オペレーションボード初期化完了 (言語: $LANG_SETTING, シェル: $SHELL_SETTING)"
echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 4: tmux の存在確認
# ═══════════════════════════════════════════════════════════════════════════════
if ! command -v tmux &> /dev/null; then
    echo ""
    echo "  ╔════════════════════════════════════════════════════════╗"
    echo "  ║  [ERROR] tmux not found!                              ║"
    echo "  ║  tmux が検出されない                                   ║"
    echo "  ╠════════════════════════════════════════════════════════╣"
    echo "  ║  Run first_setup.sh first:                            ║"
    echo "  ║  まず first_setup.sh を実行せよ:                       ║"
    echo "  ║     ./first_setup.sh                                  ║"
    echo "  ╚════════════════════════════════════════════════════════╝"
    echo ""
    exit 1
fi

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 5: bridge セッション作成（1ペイン・window 0 を必ず確保）
# ═══════════════════════════════════════════════════════════════════════════════
log_war "👑 艦長のブリッジを構築中..."

# bridge セッションがなければ作る（-s 時もここで必ず bridge が存在するようにする）
# window 0 のみ作成し -n main で名前付け（第二 window にするとアタッチ時に空ペインが開くため 1 window に限定）
if ! tmux has-session -t bridge 2>/dev/null; then
    tmux new-session -d -s bridge -n main
fi

# 艦長ペインはウィンドウ名 "main" で指定（base-index 1 環境でも動く）
CAPTAIN_PROMPT=$(generate_prompt "艦長" "magenta" "$SHELL_SETTING")
tmux send-keys -t bridge:main "cd \"$(pwd)\" && export PS1='${CAPTAIN_PROMPT}' && clear" Enter
tmux select-pane -t bridge:main -P 'bg=#002b36'  # 艦長の Solarized Dark

log_success "  └─ 艦長のブリッジ、構築完了"
echo ""

# pane-base-index を取得（1 の環境ではペインは 1,2,... になる）
PANE_BASE=$(tmux show-options -gv pane-base-index 2>/dev/null || echo 0)

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 5.1: hangar セッション作成（9ペイン：tactical + pilot1-8）
# ═══════════════════════════════════════════════════════════════════════════════
log_war "⚔️ 戦術長・パイロットのハンガーを構築中（9機配備）..."

# 最初のペイン作成
if ! tmux new-session -d -s hangar -n "agents" 2>/dev/null; then
    echo ""
    echo "  ╔════════════════════════════════════════════════════════════╗"
    echo "  ║  [ERROR] Failed to create tmux session 'hangar'            ║"
    echo "  ║  tmux セッション 'hangar' の作成に失敗した               ║"
    echo "  ╠════════════════════════════════════════════════════════════╣"
    echo "  ║  An existing session may be running.                     ║"
    echo "  ║  既存セッションが残っている可能性がある                  ║"
    echo "  ║                                                          ║"
    echo "  ║  Check: tmux ls                                          ║"
    echo "  ║  Kill:  tmux kill-session -t hangar                      ║"
    echo "  ╚════════════════════════════════════════════════════════════╝"
    echo ""
    exit 1
fi

# 3x3グリッド作成（合計9ペイン＝9機格納）
# ペイン番号は pane-base-index に依存（0 または 1）
# 最初に3列に分割
tmux split-window -h -t "hangar:agents"
tmux split-window -h -t "hangar:agents"

# 各列を3行に分割
tmux select-pane -t "hangar:agents.${PANE_BASE}"
tmux split-window -v
tmux split-window -v

tmux select-pane -t "hangar:agents.$((PANE_BASE+3))"
tmux split-window -v
tmux split-window -v

tmux select-pane -t "hangar:agents.$((PANE_BASE+6))"
tmux split-window -v
tmux split-window -v

# ペインタイトル設定（0: tactical, 1-8: pilot1-8）
PANE_TITLES=("tactical" "pilot1" "pilot2" "pilot3" "pilot4" "pilot5" "pilot6" "pilot7" "pilot8")
# 色設定（tactical: 赤, pilot: 青）
PANE_COLORS=("red" "blue" "blue" "blue" "blue" "blue" "blue" "blue" "blue")

for i in {0..8}; do
    p=$((PANE_BASE + i))
    tmux select-pane -t "hangar:agents.${p}" -T "${PANE_TITLES[$i]}"
    PROMPT_STR=$(generate_prompt "${PANE_TITLES[$i]}" "${PANE_COLORS[$i]}" "$SHELL_SETTING")
    tmux send-keys -t "hangar:agents.${p}" "cd \"$(pwd)\" && export PS1='${PROMPT_STR}' && clear" Enter
done

log_success "  └─ 戦術長・パイロットのハンガー、構築完了"
echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 6: Claude Code 起動（-s / --setup-only のときはスキップ）
# ═══════════════════════════════════════════════════════════════════════════════
if [ "$SETUP_ONLY" = false ]; then
    # Claude Code CLI の存在チェック
    if ! command -v claude &> /dev/null; then
        log_info "⚠️  claude コマンドが見つからない"
        echo "  first_setup.sh を再実行せよ:"
        echo "    ./first_setup.sh"
        exit 1
    fi

    log_war "👑 全機に Claude Code を接続中..."

    # 艦長
    tmux send-keys -t bridge:main "MAX_THINKING_TOKENS=0 claude --model opus --dangerously-skip-permissions"
    tmux send-keys -t bridge:main Enter
    log_info "  └─ 艦長、接続完了"

    # 少し待機（安定のため）
    sleep 1

    # 戦術長 + パイロット（9ペイン）
    for i in {0..8}; do
        p=$((PANE_BASE + i))
        tmux send-keys -t "hangar:agents.${p}" "claude --dangerously-skip-permissions"
        tmux send-keys -t "hangar:agents.${p}" Enter
    done
    log_info "  └─ 戦術長・パイロット、接続完了"

    log_success "✅ 全機 Claude Code 起動完了"
    echo ""

    # ═══════════════════════════════════════════════════════════════════════════
    # STEP 6.5: 各エージェントに指示書を読み込ませる
    # ═══════════════════════════════════════════════════════════════════════════
    log_war "📜 各エージェントにオペレーション指示を伝達中..."
    echo ""

    # ═══════════════════════════════════════════════════════════════════════════
    # エースパイロット（syntax-samurai/ryu - CC0 1.0 Public Domain）
    # ═══════════════════════════════════════════════════════════════════════════
    echo -e "\033[1;35m  ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\033[0m"
    echo -e "\033[1;35m  │\033[0m                              \033[1;37m【 エースパイロット 】\033[0m  Ryu Hayabusa (CC0 Public Domain)                    \033[1;35m│\033[0m"
    echo -e "\033[1;35m  └────────────────────────────────────────────────────────────────────────────────────────────────────────────┘\033[0m"

    cat << 'NINJA_EOF'
...................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                        ...................................
..................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                        ...................................
..................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                        ...................................
..................................░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                        ...................................
..................................░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                        ...................................
..................................░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▒▒                         ...................................
..................................░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒  ▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▒▒▒                         ...................................
..................................░░░░░░░░░░░░░░░░▒▒▒▒          ▒▒▒▒▒▒▒▒░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░▒▒▒▒▒▒▒▒▒                             ...................................
..................................░░░░░░░░░░░░░░▒▒▒▒               ▒▒▒▒▒░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                                ...................................
..................................░░░░░░░░░░░░░▒▒▒                    ▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                                    ...................................
..................................░░░░░░░░░░░░▒                            ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒                                        ...................................
..................................░░░░░░░░░░░      ░░░░░░░░░░░░░                                      ░░░░░░░░░░░░       ▒          ...................................
..................................░░░░░░░░░░ ▒    ░░░▓▓▓▓▓▓▓▓▓▓▓▓░░                                 ░░░░░░░░░░░░░░░ ░               ...................................
..................................░░░░░░░░░░     ░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░                          ░░░░░░░░░░░░░░░░░░░                ...................................
..................................░░░░░░░░░ ▒  ░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░             ░░▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░  ░   ▒         ...................................
..................................░░░░░░░░ ░  ░░░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░ ░  ▒         ...................................
..................................░░░░░░░░ ░  ░░░░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░  ░    ▒        ...................................
..................................░░░░░░░░░▒  ░ ░               ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░▓▓▓▓▓▓▓▓▓▓▓░                 ░            ...................................
.................................░░░░░░░░░░   ░░░  ░                 ▓▓▓▓▓▓▓▓░▓▓▓▓░░░▓░░░░░░▓▓▓▓▓                    ░ ░   ▒         ..................................
.................................░░░░░░░░▒▒   ░░░░░ ░                  ▓▓▓▓▓▓░▓▓▓▓░░▓▓▓░░░░░░▓▓                    ░  ░ ░  ▒         ..................................
.................................░░░░░░░░▒    ░░░░░░░░░ ░                 ░▓░░▓▓▓▓▓░▓▓▓░░░░░                   ░ ░░ ░░ ░   ▒         ..................................
.................................░░░░░░░▒▒    ░░░░░░░   ░░                    ▓▓▓▓▓▓▓▓▓░░                   ░░    ░ ░░ ░    ▒        ..................................
.................................░░░░░░░▒▒    ░░░░░░░░░░                      ░▓▓▓▓▓▓▓░░░                     ░░░  ░  ░ ░   ▒        ..................................
.................................░░░░░░░ ▒    ░░░░░░                         ░░░▓▓▓░▓░░░░      ░                  ░ ░░ ░    ▒        ..................................
.................................░░░░░░░ ▒    ░░░░░░░     ▓▓        ▓  ░░ ░░░░░░░░░░░░░  ░   ░░  ▓        █▓       ░  ░ ░   ▒▒       ..................................
..................................░░░░░▒ ▒    ░░░░░░░░  ▓▓██  ▓  ██ ██▓  ▓ ░░░▓░  ░ ░ ░░░░  ▓   ██ ▓█  ▓  ██▓▓  ░░░░  ░ ░    ▒      ...................................
..................................░░░░░▒ ▒▒   ░░░░░░░░░  ▓██  ▓▓  ▓ ██▓  ▓░░░░▓▓░  ░░░░░░░░ ▓  ▓██ ▓   ▓  ██▓▓ ░░░░░░░ ░     ▒      ...................................
..................................░░░░░  ▒░   ░░░░░░░▓░░ ▓███  ▓▓▓▓ ███░  ░░░░▓▓░░░░░░░░░░    ░▓██  ▓▓▓  ███▓ ░░▓▓░░  ░    ▒ ▒      ...................................
...................................░░░░  ▒░    ░░░░▓▓▓▓▓▓░  ███    ██      ░░░░░▓▓▓▓▓░░░░░░░     ███   ████ ░░▓▓▓▓░░  ░    ▒ ▒      ...................................
...................................░░░░ ▒ ░▒    ░░▓▓▓▓▓▓▓▓▓▓ ██████  ▓▓▓░░ ░░░░▓▓▓▓▓▓░░░░░░░░░▓▓▓   █████  ▓▓▓▓▓▓▓░░░░    ▒▒ ▒      ...................................
...................................░░░░ ░ ░░     ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█░░░░░░░▓▓▓▓▓▓▓░░░░ ░░   ░░▓░▓▓░░░░░░░▓▓▓▓▓▓░░      ▒▒ ▒      ...................................
...................................░░░░ ░ ░░      ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██  ░░░░░░░▓▓▓▓▓▓▓░░░░  ░░░░░   ░░░░░░░░░▓▓▓▓▓░░ ░    ▒▒  ▒      ...................................
...................................░░░░▒░░▒░░      ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░▓▓▓▓▓▓▓▓░░░  ░░░░░░░░░░░░░░░░░░▓▓░░░░      ▒▒  ▒     ....................................
...................................░░░░▒░░ ░░       ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░▓▓▓▓▓▓▓▓▓░░░░  ░░░░░░░░░░░░░░░░░░░░░        ▒▒  ▒     ....................................
...................................░░░░░░░ ▒░▒       ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░▓▓▓░░   ░░░░░  ░░░░░░░░░░░░░░░░░░░░         ▒   ▒     ....................................
...................................░░░░░░░░░░░           ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓              ░    ░░░░░░░░░░░░░░░            ▒   ▒     ....................................
....................................░░░░░░░░░░░▒  ▒▒        ▓▓▓▓▓▓▓▓▓▓▓▓▓  ░░░░░░░░░░▒▒                         ▒▒▒▒▒   ▒    ▒    .....................................
....................................░░░░░░░░░░ ░▒ ▒▒▒░░░        ▓▓▓▓▓▓   ░░░░░░░░░░░░░▒▒▒      ▒▒▒▒▒░░░░▒▒    ▒▒▒▒▒▒▒  ▒▒    ▒    .....................................
....................................░░░░░░░░░░ ░░░ ▒▒▒░░░░░░          ░░░░░ ░░░░░░░░░░▒░▒     ▒▒▒▒▒▒░░░░░░▒▒▒▒▒░▒▒▒▒   ▒▒         .....................................
.....................................░░░░░░░░░░ ░░░░░  ▒▒░░░░░░░░░░░░░    ░░░░░░░░░  ▒░▒▒    ▒▒▒▒▒░░░░▒▒▒▒▒▒░░▒▒▒   ▒▒▒         ......................................
.....................................░░░░░░░░░░░░░░░░░░  ▒░░░░░░░░░░░   ░░░░░░░░░░░░░░   ▒   ▒▒▒▒▒▒▒░▒▒▒▒▒▒░░░░▒▒▒   ▒▒          ......................................
.....................................░░░░░░░░░░░ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░      ▒▒▒▒▒▒▒    ▒  ░░░▒▒▒▒  ▒▒▒          ......................................
......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ ▒░▒▒▒ ▒▒▒    ▒░░░░░░░░░░▒   ▒▒▒▒      ▒   .......................................
......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒  ░░▒▒▒▒▒▒░░░░░░░░░░░░░▒  ░▒▒▒▒       ▒   .......................................
......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒ ▒▒░▒▒▒▒▒▒▒░░░░░░░░░░  ░░▒▒▒▒▒       ▒   .......................................
......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒ ░▒▒▒▒▒▒▒▒▒░░▒░░░░░░ ░░▒▒▒▒▒▒      ▒    .......................................
.......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒░░▒░▒▒▒ ▒▒▒▒▒░░░░░░░░░▒▒▒▒▒        ▒    .......................................
.......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒░▒▒▒▒▒     ░░░░░░░░▒▒▒▒▒▒        ▒    .......................................
.......................................░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒░░▒░▒▒▒▒▒▒  ▒░░░░░░░▒▒▒▒▒▒        ▒     .......................................
NINJA_EOF

    echo ""
    echo -e "                                    \033[1;35m「 ローンチシークエンス完了！全機発進せよ！ 」\033[0m"
    echo ""
    echo -e "                               \033[0;36m[ASCII Art: syntax-samurai/ryu - CC0 1.0 Public Domain]\033[0m"
    echo ""

    echo "  Claude Code の起動を待機中（最大30秒）..."

    # 艦長の起動を確認（最大30秒待機）
    for i in {1..30}; do
        if tmux capture-pane -t bridge:main -p | grep -q "bypass permissions"; then
            echo "  └─ 艦長の Claude Code 起動確認完了（${i}秒）"
            break
        fi
        sleep 1
    done

    # 艦長に指示書を読み込ませる
    log_info "  └─ 艦長に指示書を伝達中..."
    tmux send-keys -t bridge:main "instructions/captain.md を読んで役割を理解せよ。"
    sleep 0.5
    tmux send-keys -t bridge:main Enter

    # 戦術長に指示書を読み込ませる
    sleep 2
    log_info "  └─ 戦術長に指示書を伝達中..."
    tmux send-keys -t "hangar:agents.${PANE_BASE}" "instructions/tactical.md を読んで役割を理解せよ。"
    sleep 0.5
    tmux send-keys -t "hangar:agents.${PANE_BASE}" Enter

    # パイロットに指示書を読み込ませる（1-8）
    sleep 2
    log_info "  └─ パイロットに指示書を伝達中..."
    for i in {1..8}; do
        p=$((PANE_BASE + i))
        tmux send-keys -t "hangar:agents.${p}" "instructions/pilot.md を読んで役割を理解せよ。汝はパイロット${i}号である。"
        sleep 0.3
        tmux send-keys -t "hangar:agents.${p}" Enter
        sleep 0.5
    done

    log_success "✅ 全機に指示伝達完了"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 7: 環境確認・完了メッセージ
# ═══════════════════════════════════════════════════════════════════════════════
log_info "🔍 編成を確認中..."
echo ""
echo "  ┌──────────────────────────────────────────────────────────┐"
echo "  │  📺 Tmuxセッション (Sessions)                             │"
echo "  └──────────────────────────────────────────────────────────┘"
tmux list-sessions | sed 's/^/     /'
echo ""
echo "  ┌──────────────────────────────────────────────────────────┐"
echo "  │  📋 編成図 (Formation)                                   │"
echo "  └──────────────────────────────────────────────────────────┘"
echo ""
echo "     【bridgeセッション】艦長のブリッジ"
echo "     ┌─────────────────────────────┐"
echo "     │  Pane 0: 艦長 (CAPTAIN)     │  ← 司令官・プロジェクト統括"
echo "     └─────────────────────────────┘"
echo ""
echo "     【hangarセッション】戦術長・パイロットのハンガー（3x3 = 9ペイン）"
echo "     ┌─────────┬─────────┬─────────┐"
echo "     │tactical │ pilot3  │ pilot6  │"
echo "     │(戦術長) │(Pilot3) │(Pilot6) │"
echo "     ├─────────┼─────────┼─────────┤"
echo "     │ pilot1  │ pilot4  │ pilot7  │"
echo "     │(Pilot1) │(Pilot4) │(Pilot7) │"
echo "     ├─────────┼─────────┼─────────┤"
echo "     │ pilot2  │ pilot5  │ pilot8  │"
echo "     │(Pilot2) │(Pilot5) │(Pilot8) │"
echo "     └─────────┴─────────┴─────────┘"
echo ""

echo ""
echo "  ╔══════════════════════════════════════════════════════════╗"
echo "  ║  🚀 出撃準備完了！全システム正常！                        ║"
echo "  ╚══════════════════════════════════════════════════════════╝"
echo ""

if [ "$SETUP_ONLY" = true ]; then
    echo "  ⚠️  セットアップのみモード: Claude Codeは未起動である"
    echo ""
    echo "  手動でClaude Codeを起動するには:"
    echo "  ┌──────────────────────────────────────────────────────────┐"
    echo "  │  # 艦長を接続                                            │"
    echo "  │  tmux send-keys -t bridge:main \\                         │"
    echo "  │    'claude --dangerously-skip-permissions' Enter         │"
    echo "  │                                                          │"
    echo "  │  # 戦術長・パイロットを一斉接続                            │"
    echo "  │  for p in \$(seq $PANE_BASE $((PANE_BASE+8))); do                                 │"
    echo "  │      tmux send-keys -t hangar:agents.\$p \\            │"
    echo "  │      'claude --dangerously-skip-permissions' Enter       │"
    echo "  │  done                                                    │"
    echo "  └──────────────────────────────────────────────────────────┘"
    echo ""
fi

echo "  次のステップ:"
echo "  ┌──────────────────────────────────────────────────────────┐"
echo "  │  艦長のブリッジにアタッチしてオペレーション開始:          │"
echo "  │     tmux attach-session -t bridge   (または: css)        │"
echo "  │                                                          │"
echo "  │  戦術長・パイロットのハンガーを確認する:                  │"
echo "  │     tmux attach-session -t hangar   (または: csm)        │"
echo "  │                                                          │"
echo "  │  ※ 各エージェントは指示書を読み込み済みである。           │"
echo "  │    すぐにオペレーションを開始できる。                     │"
echo "  └──────────────────────────────────────────────────────────┘"
echo ""
echo "  ════════════════════════════════════════════════════════════"
echo "   全システム正常！オペレーション開始！ (All systems nominal! Operation start!)"
echo "  ════════════════════════════════════════════════════════════"
echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# STEP 8: Windows Terminal でタブを開く（-t オプション時のみ）
# ═══════════════════════════════════════════════════════════════════════════════
if [ "$OPEN_TERMINAL" = true ]; then
    log_info "📺 Windows Terminal でタブを展開中..."

    # Windows Terminal が利用可能か確認
    if command -v wt.exe &> /dev/null; then
        wt.exe -w 0 new-tab wsl.exe -e bash -c "tmux attach-session -t bridge" \; new-tab wsl.exe -e bash -c "tmux attach-session -t hangar"
        log_success "  └─ ターミナルタブ展開完了"
    else
        log_info "  └─ wt.exe が見つかりません。手動でアタッチしてください。"
    fi
    echo ""
fi
